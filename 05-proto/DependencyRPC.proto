syntax = "proto3";

package dra;

// The DependencyRPC service definition.
service DependencyRPC {

    // DRA and syz-manager
    rpc GetVmOffsets (Empty) returns (Empty) {
    }
    rpc SendBasicBlockNumber (Empty) returns (Empty) {
    }
    rpc GetNewInput (Empty) returns (Inputs) {
    }
    rpc SendDependency (Dependency) returns (Empty) {
    }
    rpc GetCondition (Empty) returns (Conditions) {
    }
    rpc SendWriteAddress (WriteAddresses) returns (Empty) {
    }

    //syz-fuzzer and syz-manager
    rpc Connect (Empty) returns (Empty) {
    }
    rpc SendNewInput (Input) returns (Empty) {
    }
    rpc GetTasks (Empty) returns (Tasks) {
    }
    rpc ReturnTasks (Tasks) returns (Empty) {
    }
    rpc SendUnstableInput (UnstableInput) returns (Empty) {
    }
    rpc GetDependencyInput (Empty) returns (Inputs) {
    }
    rpc ReturnDependencyInput (Dependencytask) returns (Empty) {
    }
    rpc SendLog (Empty) returns (Empty) {
    }
    rpc sendStat (Statistic) returns (Empty) {
    }
}


message Empty {
    uint32 address = 1;
    string name = 2;
}

message Condition {

    uint64 condition_address = 1;
    uint32 syzkaller_condition_address = 2;
    uint64 uncovered_address = 3;
    uint32 syzkaller_uncovered_address = 4;

    uint32 idx = 5;
    uint64 successor = 6;

    //    map<uint64, uint32> right_branch_address = 7;
    //    map<uint32, uint32> syzkaller_right_branch_address = 8;
    //    map<uint64, uint32> wrong_branch_address = 9;
    //    map<uint32, uint32> syzkaller_wrong_branch_address = 10;

    repeated uint64 right_branch_address = 7;
    repeated uint32 syzkaller_right_branch_address = 8;
    //    repeated uint64 wrong_branch_address = 9;
    //    repeated uint32 syzkaller_wrong_branch_address = 10;

}

message Conditions {
    //    map<uint64, Condition> condition = 10;
    repeated Condition condition = 10;
}

message WriteAddresses {
    Condition condition = 1;
    //    map<uint32, WriteAddress> write_address = 4;
    repeated WriteAddress write_address = 4;
}

message Call {
    uint32 idx = 1;
    map<uint32, uint32> address = 2;
    //    repeated uint32 address = 2;
}

message Inputs {
    // map<string, Input> input = 1;
    repeated Input input = 1;
}

//for syz-fuzzer
message Dependencytask {
    Input input = 1;
    string name = 41;
}

enum taskStatus {
    untested = 0;
    recursive = 1;
    tested = 2;
    out = 3;
    covered = 4;
    testing = 5;
    unstable = 6;
}

message runTimeData {
    bytes program = 2;
    taskStatus task_status = 3;
    uint32 rcursive_count = 4;
    uint32 priority = 5;

    uint32 idx = 10;

    bool checkCondition = 11;
    uint32 condition_address = 12;

    bool checkAddress = 13;
    uint32 address = 14;

    bool checkRightBranchAddress = 15;
    //    map<uint32, uint32> right_branch_address = 16;
    repeated uint32 right_branch_address = 16;
}

message IoctlCmdInput {

    string sig = 1;
    // bits
    uint32 index = 2;

    uint64 cmd = 11;

    uint32 write_address = 21;

}

message IoctlCmd {
    string name = 1;
    uint64 cmd = 2;

    //    repeated Condition critical_condition = 4;
    //    map<uint32, Condition> critical_condition = 4;
    // it is the data of this syscall
    runTimeData run_time_date = 5;

    //    repeated WriteAddress write_address = 11;
    map<uint32, uint32> write_address = 11;
    // sig, write address
    //    map<string, IoctlCmdInput> input = 12;
}

message WriteAddress {

    // the address writes to global variable
    uint32 write_address = 2;
    // the address of condition is related to this global variable
    uint32 condition_address = 3;

    //    map<uint32, Input> write_input = 4;
    //    map<uint32, Syscall> write_syscall = 5;
    //    repeated Input write_input = 4;
    //    repeated Syscall write_syscall = 5;

    // uncovered address,
    map<uint32, writeAddressAttributes> uncovered_address = 23;
    // cmd,
    map<uint64, uint32> ioctl_cmd = 24;
    // sig, index by bits
    map<string, uint32> input = 25;

    // it is the data of uncovered address
    runTimeData run_time_date = 11;
}

message writeAddressAttributes {
    // the address writes to global variable
    uint32 write_address = 2;
    uint32 repeat = 7;
    uint32 prio = 6;
}

enum UncoveredAddressKind {
    Outside = 0;
    InputRelated = 1;
    DependnecyRelated = 2;
    Other = 3;
}

message UncoveredAddress {

    uint32 condition_address = 1;
    uint32 uncovered_address = 2;
    repeated uint32 right_branch_address = 3;
    uint32 bbcount = 4;
    UncoveredAddressKind kind = 5;

    // sig, index by bits
    map<string, uint32> input = 22;
    map<uint32, writeAddressAttributes> write_address = 23;

    runTimeData run_time_date = 8;

}

message Path {
    repeated uint32 address = 1;
}

message UnstableInput {
    Path new_path = 1;
    Path unstable_path = 2;
    int32 idx = 3;

    string sig = 11; // hash value for each input from syzkaller
    bytes program = 12;

}

message Input {
    // for program
    string sig = 11; // hash value for each input from syzkaller
    bytes program = 12;
    map<uint32, Call> call = 13;

    // for dependency
    FuzzingStat stat = 21;
    // uncovered address, index by bits
    map<uint32, uint32> uncovered_address = 22;
    // write address, index by bits
    map<uint32, uint32> write_address = 25;

}

message Dependency {

    Input input = 1;
    UncoveredAddress uncovered_address = 2;
    repeated WriteAddress write_address = 3;

}

message RecursiveIoctlCmd {
    IoctlCmd ioctl_cmd = 1;
    repeated Condition critical_condition = 2;
    runTimeData run_time_data = 3;
    repeated RecursiveWriteAddress write_address = 11;
}

message RecursiveWriteAddress {
    WriteAddress write_address = 1;
    runTimeData run_time_data = 3;
    repeated RecursiveIoctlCmd ioctl_cmd = 4;
}


message RecursiveDependency {

    Input input = 1;
    UncoveredAddress uncovered_address = 2;
    runTimeData run_time_data = 3;
    repeated RecursiveWriteAddress write_address = 11;

}

message Corpus {
    map<string, Input> input = 1;
    map<uint32, UncoveredAddress> uncovered_address = 4;
    map<uint32, UncoveredAddress> covered_address = 2;
    map<uint32, WriteAddress> write_address = 5;
    map<uint64, IoctlCmd> ioctl_cmd = 6;
    Tasks tasks = 7;
    Tasks high_task = 8;
    map<string, Input> new_input = 9;
}

message UsefulInput {
    Input input = 1;
    double time = 2;
    uint64 num = 3;
    repeated uint32 new_address = 4;
}

enum FuzzingStat {
    StatDefault = 0;
    StatGenerate = 1;
    StatFuzz = 2;
    StatCandidate = 3;
    StatTriage = 4;
    StatMinimize = 5;
    StatSmash = 6;
    StatHint = 7;
    StatSeed = 8;
    StatDependency = 9;
}

message Statistic {
    FuzzingStat name = 1;

    uint64 executeNum = 11;
    double time = 12;
    uint64 newTestCaseNum = 13;
    uint64 newAddressNum = 14;
}

message Statistics {
    uint64 signalNum = 1;
    uint32 basic_block_number = 10;
    Coverage coverage = 8;
    map<int32, Statistic> stat = 11;
    repeated UsefulInput useful_input = 12;
}

message Task {
    string sig = 1;
    uint32 index = 2;
    bytes program = 3;

    string write_sig = 11;
    uint32 write_index = 12;
    bytes write_program = 13;
    uint32 write_address = 14;

    uint32 priority = 15;

    // uncovered address, priority
    map<uint32, runTimeData> uncovered_address = 21;
    map<uint32, runTimeData> covered_address = 23;
    taskStatus task_status = 24;
    bool check_write_address = 25;
    bool check_write_address_final = 26;
    bool check_write_address_remove = 27;
    uint32 final_idx = 28;
    uint32 final_write_idx = 29;
    uint32 remove_idx = 30;
    uint32 remove_write_idx = 31;
}

enum TaskKind {
    Normal = 0;
    High = 1;
}


message Tasks {
    string name = 41;
    TaskKind kind = 42;
    repeated Task task = 1;
}

message Time {
    double time = 1;
    int64 num = 2;
    int64 executeNum = 3;
}

message Coverage {
    map<uint32, uint32> coverage = 1;
    repeated Time time = 2;
}